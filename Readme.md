# Segment Service

–ü—Ä–æ—Å—Ç–æ–π REST API —Å–µ—Ä–≤–∏—Å –Ω–∞ Go –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Å–µ–≥–º–µ–Ω—Ç–∞–º–∏ (VK –∫–µ–π—Å).

## üì¶ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–æ–≤
- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–ø–æ ID –∏–ª–∏ —Å–ª—É—á–∞–π–Ω–æ –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É)
- –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –µ–≥–æ ID
- HTML-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä—É—á–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å API

## üß± –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
segment_service/
‚îú‚îÄ‚îÄ cmd/                    # —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (main.go)
‚îÇ   ‚îî‚îÄ‚îÄ server/
‚îÇ       ‚îî‚îÄ‚îÄ main.go
‚îú‚îÄ‚îÄ internal/
‚îÇ   ‚îú‚îÄ‚îÄ db/                # –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ db.go
‚îÇ   ‚îú‚îÄ‚îÄ models/            # –º–æ–¥–µ–ª–∏ User –∏ Segment
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ models.go
‚îÇ   ‚îú‚îÄ‚îÄ handlers/          # –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers.go
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ handlers_test.go
‚îÇ   ‚îî‚îÄ‚îÄ routes/            # –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è API
‚îÇ       ‚îî‚îÄ‚îÄ routes.go
‚îú‚îÄ‚îÄ web/                   # HTML-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
‚îÇ   ‚îî‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ docker-compose.yml     # –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è PostgreSQL
‚îú‚îÄ‚îÄ .env.example           # –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
‚îú‚îÄ‚îÄ go.mod
‚îî‚îÄ‚îÄ README.md
```

---

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ó–∞–ø—É—Å—Ç–∏ PostgreSQL —á–µ—Ä–µ–∑ Docker

```bash
docker-compose up -d
```

### 2. –ó–∞–ø—É—Å—Ç–∏ backend-—Å–µ—Ä–≤–µ—Ä

```bash
go run main.go
```

### 3. –û—Ç–∫—Ä–æ–π HTML-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

–û—Ç–∫—Ä–æ–π —Ñ–∞–π–ª `frontend.html` (–∏–ª–∏ `web/index.html`) –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –û–Ω –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ `localhost:8080`.

---

## üìå API Endpoints

### POST /segments
–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞:
```json
{
  "name": "MAIL_GPT"
}
```

### DELETE /segments/:name
–£–¥–∞–ª–µ–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞

### POST /segments/:name/assign
–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞:
- –ø–æ ID:
```json
{
  "user_ids": [1, 2, 3]
}
```
- –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É:
```json
{
  "percent": 30
}
```

### GET /users/:id/segments
–ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã –ª–µ–∂–∞—Ç –≤ `handlers_test.go` –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç SQLite in-memory:
```bash
go test ./handlers
```

–ü–æ–∫—Ä—ã—Ç–∏–µ:
- —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞
- –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## üí° –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ç–∞–±–ª–∏—Ü—ã –≤–Ω—É—Ç—Ä–∏ –±–∞–∑—ã
\dt

# —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü—ã users
\d users

# –¥–∞–Ω–Ω—ã–µ
SELECT * FROM users;
SELECT * FROM segments;
SELECT * FROM user_segments;
```

–ó–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:
```bash
docker exec -it segment_postgres psql -U postgres -d segment_service
```

---

## ‚ú® –ü—Ä–∏–º–µ—Ä curl-–∑–∞–ø—Ä–æ—Å–æ–≤

```bash
curl -X POST http://localhost:8080/segments \
     -H "Content-Type: application/json" \
     -d '{"name": "MAIL_GPT"}'

curl -X POST http://localhost:8080/segments/MAIL_GPT/assign \
     -H "Content-Type: application/json" \
     -d '{"user_ids": [15230, 19241]}'

curl http://localhost:8080/users/15230/segments
```

---

## üõ† –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- Go 1.20+
- Gin
- GORM
- PostgreSQL (—á–µ—Ä–µ–∑ Docker)
- SQLite (–¥–ª—è —Ç–µ—Å—Ç–æ–≤)

---

## üß† –ê–≤—Ç–æ—Ä/—É—á–∞—Å—Ç–Ω–∏–∫
–ê–ª–∏–Ω–∞ –í–µ–¥–µ—Ä–Ω–∏–∫–æ–≤–∞ ¬∑ 2025